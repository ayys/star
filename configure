#!/usr/bin/env bash
set -euo pipefail

script_dir=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )

# default installation prefix
prefix="/usr/local"

# read version from VERSION file
version="$(cat "${script_dir}/share/star/VERSION" 2>/dev/null || echo "unknown")"

while [[ $# -gt 0 ]]; do
	case $1 in
		--prefix=*) prefix="${1#*=}" ;;
		--prefix) prefix="$2"; shift ;;
		*) echo "Unknown option: $1" >&2; exit 1 ;;
	esac
	shift
done

# if prefix is empty, use current directory
if [[ -z "$prefix" ]]; then
	prefix="$PWD"
fi

# ensure trailing slash
prefix="${prefix%/}/"

# Create a config file for later steps
cat > "config.sh" <<EOF
# Auto-generated by configure
PREFIX="$prefix"
BINDIR="\${PREFIX}bin"
LIBEXECDIR="\${PREFIX}libexec/star"
SHAREDIR="\${PREFIX}share/star"
VERSION="$version"
EOF

echo "Configured star:"
echo "  VERSION:     $version"
echo "  PREFIX:      ${prefix}"
echo "  BINDIR:      ${prefix}bin"
echo "  LIBEXECDIR:  ${prefix}libexec/star"
echo "  SHAREDIR:    ${prefix}share/star"
echo
echo "Configuration saved to config.sh."
echo
echo "Now run: $(realpath --relative-to="$PWD" "$script_dir")/install.sh [--release | --destdir=DIR]"
