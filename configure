#!/usr/bin/env bash
# configure â€” configure star installation

SOURCEDIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )

usage() {
	cat << EOF
Usage: configure [OPTIONS]
Configure star installation by creating a config.sh file.

This file can then be sourced by install.sh to perform the installation.

OPTIONS
	-h, --help				Show this help message and exit.

	--prefix=PREFIX			Installation prefix (default: /usr/local).
							Where to install star: e.g. if PREFIX=/usr/local,
							then star will be installed in:
							- /usr/local/bin
							- /usr/local/libexec/star
							- /usr/local/share/star
							etc.
EOF
}

main() {
	PREFIX="${PREFIX:-/usr/local}"

	local opt
	while [[ $# -gt 0 ]]; do
		opt="$1"
		shift
		case "$opt" in
			-h|--help)
				usage
				exit 0
				;;
			--prefix|--prefix=*)
				local value
				if [[ ${#opt} -eq 2 ]]; then
					value="$1"
					shift
				else
					value="${opt#*=}"
				fi
				PREFIX=$value
				;;
			*)
				echo "Invalid option: $opt" >&2
				exit 1
				;;
		esac
	done
	# ensure trailing slash
	[[ -n $PREFIX ]] && PREFIX="${PREFIX%/}/"

	set_version
	set_install_dirs

	create_config_file
}

### Specific util functions ###
set_version() {
	VERSION="$(cat "${SOURCEDIR}/share/star/VERSION" 2>/dev/null || echo "unknown")"
}

set_install_dirs() {
	BINDIR="${PREFIX}bin"
	LIBEXECDIR="${PREFIX}libexec/star"
	SHAREDIR="${PREFIX}share/star"
}

create_config_file() {
	local config_file="config.sh"
	cat > "$config_file" <<EOF
# Auto-generated by configure
SOURCEDIR="$SOURCEDIR"
PREFIX="$PREFIX"
BINDIR="$BINDIR"
LIBEXECDIR="$LIBEXECDIR"
SHAREDIR="$SHAREDIR"
VERSION="$VERSION"
EOF
	echo "Created configuration file: $(realpath --relative-to="$PWD" "$config_file")"
}

main "$@"
